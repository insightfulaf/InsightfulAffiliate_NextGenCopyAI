name: Example - Secrets Usage

# This workflow demonstrates best practices for using GitHub Secrets
# It shows various patterns for securely handling credentials in CI/CD

on:
  workflow_dispatch:  # Manual trigger only - this is an example
  # Uncomment below to run on actual events
  # push:
  #   branches: [ main ]
  # pull_request:
  #   branches: [ main ]

jobs:
  # Example 1: Basic secret usage
  basic-secrets:
    name: Basic Secrets Usage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Use secrets as environment variables
        env:
          # ✅ CORRECT: Pass secrets via environment variables
          API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "✓ Secrets are configured as environment variables"
          
          # ✅ CORRECT: Check if secret is set without revealing it
          if [ -z "$API_KEY" ]; then
            echo "❌ API_KEY is not configured"
            exit 1
          else
            echo "✓ API_KEY is configured"
          fi
          
          # ❌ NEVER DO THIS: Don't echo the actual secret!
          # echo "API Key: $API_KEY"  # WRONG!
          
          # ✅ CORRECT: Use the secret in your application
          # python script.py  # Script reads from environment variables

  # Example 2: SSH key handling
  ssh-deployment:
    name: SSH Key Deployment Example
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure SSH with secret key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          echo "Setting up SSH configuration..."
          
          # Create .ssh directory with correct permissions
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write private key to file
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Configure SSH to use the key
          cat >> ~/.ssh/config << 'EOF'
          Host deploy-server
            HostName example.com
            User deploy-user
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF
          chmod 600 ~/.ssh/config
          
          echo "✓ SSH configured successfully"
      
      - name: Test SSH connection
        run: |
          echo "Testing SSH connection (dry-run)..."
          # In a real deployment, you would connect here:
          # ssh deploy-server 'echo "Connected successfully"'
          echo "✓ SSH connection would be tested here"
      
      - name: Cleanup sensitive files
        if: always()
        run: |
          # Always cleanup sensitive files, even if previous steps fail
          rm -f ~/.ssh/deploy_key
          echo "✓ SSH key cleaned up"

  # Example 3: Multiple secrets with validation
  multi-service-deployment:
    name: Multi-Service Secrets Example
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate all required secrets
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Validating required secrets..."
          
          EXIT_CODE=0
          
          # Check each required secret
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "❌ OPENAI_API_KEY is not set"
            EXIT_CODE=1
          else
            echo "✓ OPENAI_API_KEY is configured"
          fi
          
          if [ -z "$AWS_ACCESS_KEY_ID" ]; then
            echo "⚠ AWS_ACCESS_KEY_ID is not set (optional)"
          else
            echo "✓ AWS_ACCESS_KEY_ID is configured"
          fi
          
          if [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
            echo "⚠ AWS_SECRET_ACCESS_KEY is not set (optional)"
          else
            echo "✓ AWS_SECRET_ACCESS_KEY is configured"
          fi
          
          if [ -z "$DATABASE_URL" ]; then
            echo "⚠ DATABASE_URL is not set (optional)"
          else
            echo "✓ DATABASE_URL is configured"
          fi
          
          exit $EXIT_CODE
      
      - name: Use secrets in deployment
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          echo "Deploying with multiple credentials..."
          # Your deployment script would run here
          # ./deploy.sh
          echo "✓ Deployment would execute here"

  # Example 4: Environment-specific secrets
  environment-secrets:
    name: Environment-Specific Secrets
    runs-on: ubuntu-latest
    # This job uses secrets from the 'staging' environment
    # Configure environments in Settings → Environments
    environment: 
      name: staging
      url: https://staging.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to staging environment
        env:
          # These secrets come from the 'staging' environment
          API_KEY: ${{ secrets.API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Deploying to staging environment..."
          echo "✓ Using staging-specific secrets"
          # ./deploy.sh staging

  # Example 5: Using secrets with third-party actions
  third-party-actions:
    name: Third-Party Actions with Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Example: Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
        # Note: Only runs if secrets are configured
        if: ${{ secrets.AWS_ACCESS_KEY_ID != '' }}
      
      - name: Verify AWS configuration
        if: ${{ secrets.AWS_ACCESS_KEY_ID != '' }}
        run: |
          echo "✓ AWS credentials would be configured"
          # aws sts get-caller-identity

  # Example 6: Conditional secrets and error handling
  conditional-secrets:
    name: Conditional Secrets Example
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Use optional secrets conditionally
        env:
          OPTIONAL_API_KEY: ${{ secrets.OPTIONAL_API_KEY }}
        run: |
          echo "Checking optional secrets..."
          
          if [ -n "$OPTIONAL_API_KEY" ]; then
            echo "✓ Optional API key is available, using enhanced features"
            # Use the optional feature
          else
            echo "⚠ Optional API key not configured, using basic features"
            # Fall back to basic functionality
          fi
      
      - name: Handle missing required secrets gracefully
        env:
          REQUIRED_SECRET: ${{ secrets.REQUIRED_SECRET }}
        run: |
          if [ -z "$REQUIRED_SECRET" ]; then
            echo "❌ ERROR: REQUIRED_SECRET is not configured"
            echo "Please add this secret in repository settings:"
            echo "Settings → Secrets and variables → Actions → New repository secret"
            exit 1
          fi
          
          echo "✓ Required secret is configured"

  # Example 7: Python with secrets
  python-secrets-example:
    name: Python with Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Run Python script with secrets
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          # Create a test Python script
          cat > test_secrets.py << 'EOF'
          import os
          import sys
          
          def main():
              """Example: Using secrets in Python"""
              # ✅ CORRECT: Read from environment variables
              api_key = os.getenv('OPENAI_API_KEY')
              database_url = os.getenv('DATABASE_URL')
              
              # ✅ CORRECT: Validate secrets are present
              if not api_key:
                  print("❌ OPENAI_API_KEY environment variable is required")
                  sys.exit(1)
              
              print("✓ API key is configured")
              
              # ✅ CORRECT: Use the secret (never print it!)
              # openai_client = OpenAI(api_key=api_key)
              
              if database_url:
                  print("✓ Database URL is configured")
              else:
                  print("⚠ Database URL is not configured (optional)")
              
              print("✓ Python script completed successfully")
          
          if __name__ == '__main__':
              main()
          EOF
          
          # Run the script
          python test_secrets.py

  # Example 8: Security best practices demonstration
  security-best-practices:
    name: Security Best Practices
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: ✅ CORRECT patterns
        env:
          SECRET_VALUE: ${{ secrets.EXAMPLE_SECRET }}
        run: |
          echo "=== CORRECT Secret Usage Patterns ==="
          
          # ✅ Check if secret exists without revealing it
          if [ -n "$SECRET_VALUE" ]; then
            echo "✓ Secret is configured"
          fi
          
          # ✅ Use secret in a file with restricted permissions
          if [ -n "$SECRET_VALUE" ]; then
            echo "$SECRET_VALUE" > /tmp/secret_file
            chmod 600 /tmp/secret_file
            echo "✓ Secret written to protected file"
          fi
          
          # ✅ Pass secret via stdin (not command line)
          if [ -n "$SECRET_VALUE" ]; then
            echo "$SECRET_VALUE" | wc -c > /dev/null
            echo "✓ Secret processed via stdin"
          fi
          
          # ✅ Clean up secret files
          rm -f /tmp/secret_file
          echo "✓ Secret file cleaned up"
      
      - name: ❌ INCORRECT patterns (for education only)
        run: |
          echo "=== INCORRECT Patterns (NEVER DO THIS) ==="
          echo ""
          echo "❌ NEVER: echo secrets"
          echo "   # echo \${{ secrets.SECRET }}  # WRONG!"
          echo ""
          echo "❌ NEVER: Log secrets"
          echo "   # console.log('API Key:', process.env.SECRET)  # WRONG!"
          echo ""
          echo "❌ NEVER: Write secrets to unprotected files"
          echo "   # echo \$SECRET > secret.txt  # WRONG!"
          echo ""
          echo "❌ NEVER: Pass secrets as command-line arguments"
          echo "   # curl -H 'Authorization: Bearer \$SECRET' url  # WRONG!"
          echo "   # Use: curl -H \"Authorization: Bearer \$SECRET\" url  # BETTER"
          echo ""
          echo "✓ Review these anti-patterns and avoid them in your code"

  # Example 9: Artifact handling with secrets
  artifacts-with-secrets:
    name: Artifacts and Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate configuration file
        env:
          API_KEY: ${{ secrets.EXAMPLE_API_KEY }}
        run: |
          echo "Generating configuration file..."
          
          # ✅ CORRECT: Create config without secrets for artifacts
          cat > public_config.json << 'EOF'
          {
            "environment": "production",
            "region": "us-east-1",
            "features": {
              "logging": true,
              "monitoring": true
            }
          }
          EOF
          
          # ❌ NEVER include secrets in artifacts!
          # Artifacts can be downloaded by anyone with repo access
          
          echo "✓ Configuration file created (without secrets)"
      
      - name: Upload artifact (safe - no secrets)
        uses: actions/upload-artifact@v4
        with:
          name: configuration
          path: public_config.json
          retention-days: 7

  # Summary job
  summary:
    name: Examples Summary
    runs-on: ubuntu-latest
    needs: 
      - basic-secrets
      - ssh-deployment
      - multi-service-deployment
      - environment-secrets
      - third-party-actions
      - conditional-secrets
      - python-secrets-example
      - security-best-practices
      - artifacts-with-secrets
    if: always()
    
    steps:
      - name: Print summary
        run: |
          echo "================================================"
          echo "GitHub Secrets Usage Examples - Summary"
          echo "================================================"
          echo ""
          echo "This workflow demonstrated:"
          echo "  ✓ Basic secret usage with environment variables"
          echo "  ✓ SSH key configuration and deployment"
          echo "  ✓ Multiple secrets validation"
          echo "  ✓ Environment-specific secrets"
          echo "  ✓ Third-party actions with secrets"
          echo "  ✓ Conditional secret usage"
          echo "  ✓ Python integration examples"
          echo "  ✓ Security best practices"
          echo "  ✓ Artifact handling guidelines"
          echo ""
          echo "For more information, see:"
          echo "  - docs/SECRETS_MANAGEMENT.md"
          echo "  - docs/SSH_KEY_SECURITY.md"
          echo "  - SETUP_SECRETS.md"
          echo ""
          echo "To configure secrets:"
          echo "  Settings → Secrets and variables → Actions"
          echo ""
